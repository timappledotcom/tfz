name: Build and Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-deb:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Build Debian package
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          mkdir -p dist pkg/DEBIAN pkg/opt/tfz pkg/usr/bin
          
          cp -r bin lib Gemfile Gemfile.lock pkg/opt/tfz/
          
          cat > pkg/usr/bin/tfz << 'WRAPPER'
          #!/usr/bin/env bash
          cd /opt/tfz
          exec bundle exec ruby bin/tfz "$@"
          WRAPPER
          chmod +x pkg/usr/bin/tfz
          
          cat > pkg/DEBIAN/control << EOF
          Package: tfz
          Version: $VERSION
          Section: utils
          Priority: optional
          Architecture: all
          Depends: ruby (>= 3.0), ruby-bundler
          Maintainer: Tim Fall <tim@example.com>
          Description: Terminal-based RSS/Atom feed reader
           A beautiful terminal-based RSS/Atom feed reader with full article
           rendering, category organization, and vim-style navigation.
          EOF
          
          cat > pkg/DEBIAN/postinst << 'EOF'
          #!/bin/bash
          cd /opt/tfz
          bundle install --quiet --deployment --without development test 2>/dev/null || bundle install --quiet
          EOF
          chmod +x pkg/DEBIAN/postinst
          
          dpkg-deb --build pkg dist/tfz_${VERSION}_all.deb
      
      - uses: actions/upload-artifact@v4
        with:
          name: deb-package
          path: dist/*.deb

  build-rpm:
    runs-on: ubuntu-latest
    container: fedora:latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install build tools
        run: dnf install -y rpm-build
      
      - name: Build RPM package
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          mkdir -p dist staging/opt/tfz staging/usr/bin
          
          cp -r bin lib Gemfile Gemfile.lock staging/opt/tfz/
          
          cat > staging/usr/bin/tfz << 'WRAPPER'
          #!/usr/bin/env bash
          cd /opt/tfz
          exec bundle exec ruby bin/tfz "$@"
          WRAPPER
          chmod +x staging/usr/bin/tfz
          
          tar czf ~/rpmbuild/SOURCES/tfz-${VERSION}.tar.gz -C staging .
          
          cat > ~/rpmbuild/SPECS/tfz.spec << EOF
          Name:           tfz
          Version:        $VERSION
          Release:        1%{?dist}
          Summary:        Terminal-based RSS/Atom feed reader
          License:        MIT
          Source0:        tfz-%{version}.tar.gz
          BuildArch:      noarch
          Requires:       ruby >= 3.0, rubygem-bundler
          
          %description
          A beautiful terminal-based RSS/Atom feed reader with full article
          rendering, category organization, and vim-style navigation.
          
          %prep
          %setup -c
          
          %install
          mkdir -p %{buildroot}/opt/tfz %{buildroot}/usr/bin
          cp -r opt/tfz/* %{buildroot}/opt/tfz/
          cp usr/bin/tfz %{buildroot}/usr/bin/
          
          %post
          cd /opt/tfz
          bundle install --quiet --deployment --without development test 2>/dev/null || bundle install --quiet
          
          %files
          /opt/tfz
          /usr/bin/tfz
          EOF
          
          rpmbuild -bb ~/rpmbuild/SPECS/tfz.spec
          cp ~/rpmbuild/RPMS/noarch/*.rpm dist/
      
      - uses: actions/upload-artifact@v4
        with:
          name: rpm-package
          path: dist/*.rpm

  build-arch:
    runs-on: ubuntu-latest
    container: archlinux:latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup build environment
        run: |
          pacman -Syu --noconfirm base-devel sudo ruby ruby-bundler
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          chown -R builder:builder .
      
      - name: Build Arch package
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          mkdir -p dist
          
          cat > PKGBUILD << EOF
          pkgname=tfz
          pkgver=$VERSION
          pkgrel=1
          pkgdesc="Terminal-based RSS/Atom feed reader"
          arch=('any')
          url="https://github.com/timappledotcom/tfz"
          license=('MIT')
          depends=('ruby' 'ruby-bundler')
          source=()
          
          package() {
              mkdir -p "\$pkgdir/opt/tfz" "\$pkgdir/usr/bin"
              cp -r \$startdir/bin \$startdir/lib \$startdir/Gemfile \$startdir/Gemfile.lock "\$pkgdir/opt/tfz/"
              
              cat > "\$pkgdir/usr/bin/tfz" << 'WRAPPER'
          #!/usr/bin/env bash
          cd /opt/tfz
          exec bundle exec ruby bin/tfz "\$@"
          WRAPPER
              chmod +x "\$pkgdir/usr/bin/tfz"
          }
          EOF
          
          chown builder:builder PKGBUILD
          su builder -c "makepkg -f"
          cp *.pkg.tar.zst dist/
      
      - uses: actions/upload-artifact@v4
        with:
          name: arch-package
          path: dist/*.pkg.tar.zst

  build-tarball:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Create tarball
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          mkdir -p dist tfz-${VERSION}
          cp -r bin lib Gemfile Gemfile.lock README.md LICENSE tfz-${VERSION}/
          tar czf dist/tfz-${VERSION}.tar.gz tfz-${VERSION}
      
      - uses: actions/upload-artifact@v4
        with:
          name: tarball
          path: dist/*.tar.gz

  release:
    needs: [build-deb, build-rpm, build-arch, build-tarball]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/deb-package/*
            artifacts/rpm-package/*
            artifacts/arch-package/*
            artifacts/tarball/*
          generate_release_notes: true
